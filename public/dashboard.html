<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: rgba(255,255,255,0.04);
      --surface-hover: rgba(255,255,255,0.07);
      --border: rgba(255,255,255,0.08);
      --text: #e4e4e7;
      --text-muted: #71717a;
      --text-dim: #52525b;
      --accent: #818cf8;
      --accent-dim: rgba(129,140,248,0.15);
      --green: #34d399;
      --green-dim: rgba(52,211,153,0.15);
      --yellow: #fbbf24;
      --yellow-dim: rgba(251,191,36,0.15);
      --red: #f87171;
      --blue: #60a5fa;
      --blue-dim: rgba(96,165,250,0.15);
      --purple: #a78bfa;
      --purple-dim: rgba(167,139,250,0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* Header */
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50;
      background: rgba(10,10,15,0.85); backdrop-filter: blur(12px);
    }
    .logo { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .logo .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px var(--green); }
    .header-right { display: flex; align-items: center; gap: 0.75rem; }
    .conn { font-size: 0.7rem; color: var(--text-dim); display: flex; align-items: center; gap: 0.35rem; }
    .conn .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-dim); }
    .conn.live .dot { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .conn.live { color: var(--text-muted); }
    .user { display: flex; align-items: center; gap: 0.5rem; }
    .user img { width: 28px; height: 28px; border-radius: 50%; }
    .user span { font-size: 0.8rem; color: var(--text-muted); }
    .btn-s { font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; }
    .btn-s:hover { background: var(--surface-hover); color: var(--text); }
    .btn-token { font-size: 0.75rem; padding: 0.35rem 0.7rem; border-radius: 6px; border: 1px solid var(--accent); background: var(--accent-dim); color: var(--accent); cursor: pointer; font-weight: 600; }
    .btn-token:hover { background: var(--accent); color: #000; }

    /* Avatar fallback */
    .avatar { width: 28px; height: 28px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-fallback { width: 28px; height: 28px; border-radius: 50%; background: var(--accent-dim); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; }

    /* Token banner */
    .token-banner {
      background: linear-gradient(135deg, var(--accent-dim), var(--purple-dim));
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      display: flex; justify-content: space-between; align-items: center; gap: 1rem;
    }
    .token-banner .info { flex: 1; }
    .token-banner .info h3 { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 0.25rem; }
    .token-banner .info p { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }
    .btn-banner { font-size: 0.85rem; padding: 0.5rem 1rem; border-radius: 8px; border: none; background: var(--accent); color: #000; cursor: pointer; font-weight: 600; white-space: nowrap; }
    .btn-banner:hover { filter: brightness(1.15); }
    .token-banner.hidden { display: none; }

    /* Layout */
    .layout { display: grid; grid-template-columns: 1fr 340px; gap: 0; min-height: calc(100vh - 49px); }
    .main { padding: 1.5rem; overflow-y: auto; }
    .sidebar { border-left: 1px solid var(--border); overflow-y: auto; }

    /* Sections */
    .section { margin-bottom: 2rem; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
    .section-count { font-size: 0.65rem; color: var(--text-dim); background: var(--surface); padding: 0.15rem 0.5rem; border-radius: 999px; }

    /* Work Items */
    .work-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.85rem 1rem; margin-bottom: 0.5rem; transition: background 0.15s;
    }
    .work-card:hover { background: var(--surface-hover); }
    .work-card .top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.35rem; }
    .work-title { font-weight: 500; font-size: 0.9rem; line-height: 1.4; }
    .work-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; margin-top: 0.25rem; }
    .work-meta { display: flex; gap: 0.6rem; align-items: center; margin-top: 0.5rem; flex-wrap: wrap; }
    .tag { font-size: 0.65rem; font-weight: 500; padding: 0.15rem 0.5rem; border-radius: 4px; }
    .tag.active { background: var(--green-dim); color: var(--green); }
    .tag.completed { background: var(--surface); color: var(--text-dim); }
    .tag.task { background: var(--blue-dim); color: var(--blue); }
    .tag.research { background: var(--purple-dim); color: var(--purple); }
    .tag.deploy { background: var(--yellow-dim); color: var(--yellow); }
    .tag.agent { background: var(--accent-dim); color: var(--accent); }
    .tag.idea { background: rgba(167,139,250,0.15); color: #a78bfa; }
    .tag.business { background: rgba(251,191,36,0.15); color: #fbbf24; }
    .tag.project { background: rgba(96,165,250,0.15); color: #60a5fa; }
    .tag.learning { background: rgba(52,211,153,0.15); color: #34d399; }
    .time { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

    /* Sub-agents */
    .subagent-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.75rem 1rem; margin-bottom: 0.5rem;
    }
    .subagent-header { display: flex; justify-content: space-between; align-items: center; }
    .subagent-label { font-weight: 500; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace; }
    .subagent-task { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.3rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .status-dot.running { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); animation: pulse 2s infinite; }
    .status-dot.completed { background: var(--green); }
    .status-dot.failed { background: var(--red); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes flash {
      0% { background: rgba(129, 140, 248, 0.1); }
      100% { background: transparent; }
    }

    /* Scheduled */
    .sched-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.6rem 0; border-bottom: 1px solid var(--border);
    }
    .sched-item:last-child { border-bottom: none; }
    .sched-name { font-size: 0.85rem; font-weight: 500; }
    .sched-detail { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.15rem; }
    .sched-next { font-size: 0.7rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; text-align: right; }

    /* Activity Feed (sidebar) */
    .feed { padding: 0; }
    .feed-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    .feed-header h3 { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
    .feed-list { padding: 0; }
    .feed-item { padding: 0.65rem 1rem; border-bottom: 1px solid var(--border); }
    .feed-item:hover { background: var(--surface); }
    .feed-msg { font-size: 0.8rem; line-height: 1.5; }
    .feed-meta { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.25rem; }
    .feed-type { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .feed-type.heartbeat { color: var(--green); }
    .feed-type.work { color: var(--blue); }
    .feed-type.subagent { color: var(--purple); }
    .feed-type.deploy { color: var(--yellow); }
    .feed-type.alert { color: var(--red); }
    .feed-time { font-size: 0.65rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

    .empty { text-align: center; padding: 2rem; color: var(--text-dim); font-size: 0.85rem; }
    .empty .icon { font-size: 1.5rem; margin-bottom: 0.5rem; }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 200; }
    .modal.active { display: flex; }
    .modal-box { background: #16161d; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid var(--border); overflow: hidden; }
    .modal-head { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    .modal-head h3 { font-size: 0.95rem; }
    .modal-close { background: none; border: none; color: var(--text-dim); font-size: 1.2rem; cursor: pointer; }
    .modal-body { padding: 1rem; }
    .field { margin-bottom: 0.85rem; }
    .field label { display: block; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); margin-bottom: 0.3rem; }
    .field input, .field textarea { width: 100%; padding: 0.5rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem; font-family: inherit; }
    .field input:focus, .field textarea:focus { outline: none; border-color: var(--accent); }
    .field textarea { min-height: 60px; resize: vertical; }
    .agents-grid { display: grid; grid-template-columns: 1fr; gap: 0.5rem; }
    .agent-row { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 0.6rem 0.8rem; border-radius: 8px; }
    .agent-name { font-weight: 500; font-size: 0.85rem; }
    .agent-key { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-dim); }

    /* Usage Widget */
    .usage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
    .usage-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 1rem; text-align: center;
    }
    .usage-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); margin-bottom: 0.5rem; }
    .usage-value { font-size: 1.8rem; font-weight: 600; color: var(--text); font-family: 'JetBrains Mono', monospace; }
    .usage-breakdown { display: flex; gap: 0.75rem; justify-content: center; margin-top: 0.5rem; font-size: 0.7rem; }
    .usage-model { color: var(--text-muted); }
    .usage-model.opus { color: var(--accent); }
    .usage-model.sonnet { color: var(--green); }
    .usage-model b { font-weight: 600; color: inherit; }
    .usage-chart-container {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 1rem;
    }
    .usage-chart-header { margin-bottom: 0.75rem; }
    .usage-chart { display: flex; gap: 0.5rem; align-items: flex-end; height: 120px; }
    .usage-bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
    .usage-bar-container { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; }
    .usage-bar {
      width: 100%; border-radius: 4px 4px 0 0; transition: height 0.3s;
      background: linear-gradient(180deg, var(--accent), var(--accent-dim));
    }
    .usage-bar.sonnet { background: linear-gradient(180deg, var(--green), var(--green-dim)); }
    .usage-bar-label { font-size: 0.6rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
    .usage-bar-value { font-size: 0.65rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; margin-top: 0.15rem; }

    @media (max-width: 768px) {
      .usage-grid { grid-template-columns: 1fr; }
      .layout { grid-template-columns: 1fr; }
      .sidebar { border-left: none; border-top: 1px solid var(--border); max-height: 400px; }
      .user span { display: none; }
    }
  </style>
<script>
  !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug getPageviewId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
  posthog.init('phc_QBrEydH4duDZXg7OeNTpOrCb2lB77yn1S54FrnCt8Pp',{api_host:'https://analytics.mtree.io',person_profiles:'identified_only'})
</script>
</head>
<body>
  <header>
    <div class="logo"><span class="dot"></span> Agent Portal</div>
    <div class="header-right">
      <div class="conn" id="conn"><span class="dot"></span> connecting</div>
      <a href="/docs" class="btn-s">ðŸ“„ Docs</a>
      <a href="/chat" class="btn-s">ðŸ’¬ Chat</a>
      <button class="btn-token" onclick="openModal('agents-modal')">ðŸ”‘ API Tokens</button>
      <div class="user" id="user-info">
        <div class="avatar" id="user-avatar"></div>
        <span id="user-name"></span>
      </div>
      <a href="/auth/logout" class="btn-s">Logout</a>
    </div>
  </header>

  <div class="layout">
    <div class="main">
      <!-- Token Setup Banner (shown when no agents exist) -->
      <div class="token-banner hidden" id="token-banner">
        <div class="info">
          <h3>ðŸ”‘ Generate an API Token</h3>
          <p>Create a token so your agent can push live status updates to this dashboard.</p>
        </div>
        <button class="btn-banner" onclick="openModal('agents-modal')">Create Token</button>
      </div>

      <!-- Usage Tracking Widget -->
      <div class="section" id="usage-section">
        <div class="section-header">
          <span class="section-title">ðŸ“Š Usage & Cost</span>
          <span class="section-count" id="usage-period">Today</span>
        </div>
        <div class="usage-grid">
          <div class="usage-card">
            <div class="usage-label">Total Tokens</div>
            <div class="usage-value" id="usage-total">0</div>
            <div class="usage-breakdown">
              <span class="usage-model opus">Opus: <b id="usage-opus">0</b></span>
              <span class="usage-model sonnet">Sonnet: <b id="usage-sonnet">0</b></span>
            </div>
          </div>
          <div class="usage-card">
            <div class="usage-label">Messages</div>
            <div class="usage-value" id="usage-messages">0</div>
          </div>
          <div class="usage-card">
            <div class="usage-label">Sub-Agents</div>
            <div class="usage-value" id="usage-subagents">0</div>
          </div>
        </div>
        <div class="usage-chart-container">
          <div class="usage-chart-header">
            <span class="section-title">Last 7 Days</span>
          </div>
          <div class="usage-chart" id="usage-chart"></div>
        </div>
      </div>

      <!-- Active Work -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ”¨ Currently Working On</span>
          <span class="section-count" id="active-count">0</span>
        </div>
        <div id="active-work"></div>
      </div>

      <!-- Sub-Agents -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ¤– Sub-Agents</span>
          <span class="section-count" id="subagent-count">0</span>
        </div>
        <div id="subagents"></div>
      </div>

      <!-- Scheduled -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ“… Scheduled</span>
          <span class="section-count" id="sched-count">0</span>
        </div>
        <div id="scheduled"></div>
      </div>

      <!-- Open Threads (not concluded) -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ’¬ Open Threads</span>
          <span class="section-count" id="threads-open-count">0</span>
        </div>
        <div id="threads-open"></div>
      </div>

      <!-- Concluded Threads -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">âœ… Concluded</span>
          <span class="section-count" id="threads-concluded-count">0</span>
        </div>
        <div id="threads-concluded"></div>
      </div>

      <!-- Someday/Maybe -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ’­ Someday/Maybe</span>
          <span class="section-count" id="someday-count">0</span>
        </div>
        <div id="someday-maybe"></div>
      </div>

      <!-- Completed Work -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ“¦ Recently Completed</span>
          <span class="section-count" id="completed-count">0</span>
        </div>
        <div id="completed-work"></div>
      </div>
    </div>

    <div class="sidebar">
      <div class="feed">
        <div class="feed-header"><h3>Activity Feed</h3></div>
        <div class="feed-list" id="activity-feed"></div>
      </div>
    </div>
  </div>

  <!-- Agents / Tokens Modal -->
  <div class="modal" id="agents-modal">
    <div class="modal-box" style="max-width:550px;">
      <div class="modal-head">
        <h3>ðŸ”‘ API Tokens</h3>
        <button class="modal-close" onclick="closeModal('agents-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.85rem;line-height:1.5;">
          Tokens let agents authenticate and push live updates to the dashboard.
        </p>
        <div class="field" style="display:flex;gap:0.5rem;">
          <input id="new-agent" placeholder="Agent name (e.g. Talos)â€¦" style="flex:1">
          <button class="btn-s" style="background:var(--accent);color:#000;border:none;font-weight:600;padding:0.4rem 0.8rem;" onclick="createAgent()">Generate</button>
        </div>
        <!-- Newly created key display -->
        <div id="new-key-display" style="display:none;background:var(--green-dim);border:1px solid var(--green);border-radius:8px;padding:0.75rem;margin-bottom:0.85rem;">
          <div style="font-size:0.7rem;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.35rem;">âœ… Token Created â€” Copy It Now</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;word-break:break-all;color:var(--text);user-select:all;cursor:text;" id="new-key-value"></div>
          <div style="font-size:0.7rem;color:var(--text-dim);margin-top:0.35rem;">This is the only time this token is shown in full.</div>
        </div>
        <div class="agents-grid" id="agents-list"></div>
      </div>
    </div>
  </div>

<script>
let ws, data = { active: [], completed: [], subagents: [], scheduled: [], activity: [], threadsOpen: [], threadsConcluded: [], somedayMaybe: [], usage: { today: { opus: 0, sonnet: 0, total: 0, messages: 0, subagents: 0 }, week: { opus: 0, sonnet: 0, total: 0, messages: 0, subagents: 0 } } }, usageHistory = [];

async function init() {
  await loadUser();
  await loadDashboard();
  await checkTokenBanner();
  connectWS();
}

async function checkTokenBanner() {
  try {
    const r = await fetch('/api/agents');
    if (!r.ok) return;
    const agents = await r.json();
    const banner = document.getElementById('token-banner');
    if (agents.length === 0) {
      banner.classList.remove('hidden');
    } else {
      banner.classList.add('hidden');
    }
  } catch (e) { /* ignore */ }
}

async function loadUser() {
  const r = await fetch('/api/me');
  const u = await r.json();
  if (u) {
    const avatarEl = document.getElementById('user-avatar');
    const nameEl = document.getElementById('user-name');
    nameEl.textContent = u.name || u.email;

    if (u.picture) {
      const img = document.createElement('img');
      img.src = u.picture;
      img.alt = u.name || '';
      img.referrerPolicy = 'no-referrer';
      img.onerror = () => {
        avatarEl.innerHTML = '';
        avatarEl.appendChild(makeAvatarFallback(u.name || u.email));
      };
      avatarEl.appendChild(img);
    } else {
      avatarEl.appendChild(makeAvatarFallback(u.name || u.email));
    }
  }
}

function makeAvatarFallback(name) {
  const div = document.createElement('div');
  div.className = 'avatar-fallback';
  const initials = (name || '?').split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
  div.textContent = initials;
  return div;
}

async function loadDashboard() {
  const [dashboardRes, historyRes] = await Promise.all([
    fetch('/api/dashboard'),
    fetch('/api/usage/history?days=7')
  ]);
  data = await dashboardRes.json();
  usageHistory = await historyRes.json();
  render();
}

async function loadUsageStats() {
  const [dashboardRes, historyRes] = await Promise.all([
    fetch('/api/usage'),
    fetch('/api/usage/history?days=7')
  ]);
  const usageData = await dashboardRes.json();
  data.usage = usageData;
  usageHistory = await historyRes.json();
  renderUsage();
  flashSection('usage-section');
}

// Helper functions for updating individual items
function updateWorkItem(item) {
  // Remove from old lists
  data.active = data.active.filter(w => w.id !== item.id);
  data.completed = data.completed.filter(w => w.id !== item.id);
  data.threadsOpen = data.threadsOpen.filter(w => w.id !== item.id);
  data.threadsConcluded = data.threadsConcluded.filter(w => w.id !== item.id);
  
  // Add to appropriate list
  if (item.category === 'conversation') {
    if (item.status === 'active') {
      data.threadsOpen.unshift(item);
      renderThreads('threads-open', data.threadsOpen, 'threads-open-count', true);
      flashSection('threads-open');
    } else {
      data.threadsConcluded.unshift(item);
      renderThreads('threads-concluded', data.threadsConcluded, 'threads-concluded-count', false);
      flashSection('threads-concluded');
    }
  } else {
    if (item.status === 'active') {
      data.active.unshift(item);
      renderWork('active-work', data.active, 'active-count', true);
      flashSection('active-work');
    } else {
      data.completed.unshift(item);
      renderWork('completed-work', data.completed, 'completed-count', false);
      flashSection('completed-work');
    }
  }
}

function removeWorkItem(id) {
  data.active = data.active.filter(w => w.id !== id);
  data.completed = data.completed.filter(w => w.id !== id);
  data.threadsOpen = data.threadsOpen.filter(w => w.id !== id);
  data.threadsConcluded = data.threadsConcluded.filter(w => w.id !== id);
  renderWork('active-work', data.active, 'active-count', true);
  renderWork('completed-work', data.completed, 'completed-count', false);
  renderThreads('threads-open', data.threadsOpen, 'threads-open-count', true);
  renderThreads('threads-concluded', data.threadsConcluded, 'threads-concluded-count', false);
}

function updateSubagent(item) {
  const idx = data.subagents.findIndex(s => s.id === item.id);
  if (idx >= 0) {
    data.subagents[idx] = item;
  } else {
    data.subagents.unshift(item);
  }
  renderSubagents();
  flashSection('subagents');
}

function updateScheduled(item) {
  const idx = data.scheduled.findIndex(s => s.id === item.id);
  if (idx >= 0) {
    data.scheduled[idx] = item;
  } else {
    data.scheduled.push(item);
  }
  // Re-sort by next_run
  data.scheduled.sort((a, b) => {
    if (!a.next_run) return 1;
    if (!b.next_run) return -1;
    return new Date(a.next_run) - new Date(b.next_run);
  });
  renderScheduled();
  flashSection('scheduled');
}

function updateSomedayMaybe(item) {
  const idx = data.somedayMaybe.findIndex(s => s.id === item.id);
  if (idx >= 0) {
    data.somedayMaybe[idx] = item;
  } else {
    data.somedayMaybe.unshift(item);
  }
  renderSomedayMaybe();
  flashSection('someday-maybe');
}

function flashSection(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.animation = 'flash 0.5s ease-out';
  setTimeout(() => { el.style.animation = ''; }, 500);
}

function render() {
  renderUsage();
  renderWork('active-work', data.active, 'active-count', true);
  renderWork('completed-work', data.completed, 'completed-count', false);
  renderThreads('threads-open', data.threadsOpen || [], 'threads-open-count', true);
  renderThreads('threads-concluded', data.threadsConcluded || [], 'threads-concluded-count', false);
  renderSubagents();
  renderScheduled();
  renderSomedayMaybe();
  renderFeed();
}

function renderWork(containerId, items, countId, isActive) {
  document.getElementById(countId).textContent = items.length;
  const el = document.getElementById(containerId);
  if (!items.length) { el.innerHTML = `<div class="empty"><div class="icon">${isActive ? 'â˜•' : 'ðŸ“­'}</div>${isActive ? 'All quiet' : 'Nothing yet'}</div>`; return; }
  el.innerHTML = items.map(w => {
    const cat = w.category || 'task';
    return `<div class="work-card">
      <div class="top">
        <div class="work-title">${esc(w.title)}</div>
        <span class="tag ${isActive ? 'active' : 'completed'}">${isActive ? 'active' : 'done'}</span>
      </div>
      ${w.description ? `<div class="work-desc">${esc(w.description)}</div>` : ''}
      <div class="work-meta">
        <span class="tag ${cat}">${cat}</span>
        ${w.agent_name ? `<span class="tag agent">${esc(w.agent_name)}</span>` : ''}
        <span class="time">${relTime(isActive ? w.started_at : w.completed_at)}</span>
      </div>
    </div>`;
  }).join('');
}

function renderThreads(containerId, items, countId, isOpen) {
  document.getElementById(countId).textContent = items.length;
  const el = document.getElementById(containerId);
  if (!items.length) { el.innerHTML = `<div class="empty"><div class="icon">${isOpen ? 'ðŸ’¬' : 'âœ…'}</div>${isOpen ? 'No open threads' : 'None yet'}</div>`; return; }
  el.innerHTML = items.map(w => `
    <div class="work-card">
      <div class="top">
        <div class="work-title">${esc(w.title)}</div>
        <span class="tag ${isOpen ? 'active' : 'completed'}">${isOpen ? 'open' : 'concluded'}</span>
      </div>
      ${w.description ? `<div class="work-desc">${esc(w.description)}</div>` : ''}
      <div class="work-meta">
        <span class="tag conversation" style="background:rgba(251,191,36,0.15);color:#fbbf24;">thread</span>
        ${w.agent_name ? `<span class="tag agent">${esc(w.agent_name)}</span>` : ''}
        <span class="time">${relTime(isOpen ? w.started_at : w.completed_at)}</span>
      </div>
    </div>
  `).join('');
}

function renderSubagents() {
  const items = data.subagents;
  document.getElementById('subagent-count').textContent = items.length;
  const el = document.getElementById('subagents');
  if (!items.length) { el.innerHTML = '<div class="empty"><div class="icon">ðŸ¤–</div>No sub-agents</div>'; return; }
  el.innerHTML = items.map(s => `
    <div class="subagent-card">
      <div class="subagent-header">
        <span class="subagent-label">${esc(s.label || s.id.slice(0,8))}</span>
        <span style="display:flex;align-items:center;gap:0.4rem;">
          <span class="status-dot ${s.status}"></span>
          <span class="time">${s.status}</span>
        </span>
      </div>
      <div class="subagent-task">${esc(s.task)}</div>
      ${s.result ? `<div class="work-desc" style="margin-top:0.4rem;">${esc(s.result)}</div>` : ''}
      <div class="work-meta"><span class="time">${relTime(s.started_at)}</span></div>
    </div>
  `).join('');
}

function renderScheduled() {
  const items = data.scheduled;
  document.getElementById('sched-count').textContent = items.length;
  const el = document.getElementById('scheduled');
  if (!items.length) { el.innerHTML = '<div class="empty"><div class="icon">ðŸ“…</div>No scheduled items</div>'; return; }
  el.innerHTML = items.map(s => `
    <div class="sched-item">
      <div>
        <div class="sched-name">${esc(s.name)}</div>
        <div class="sched-detail">${esc(s.schedule_type)}${s.schedule_expr ? ' Â· ' + esc(s.schedule_expr) : ''}</div>
      </div>
      <div class="sched-next">${s.next_run ? relTime(s.next_run) : 'â€”'}</div>
    </div>
  `).join('');
}

function renderSomedayMaybe() {
  const items = data.somedayMaybe || [];
  document.getElementById('someday-count').textContent = items.length;
  const el = document.getElementById('someday-maybe');
  if (!items.length) { el.innerHTML = '<div class="empty"><div class="icon">ðŸ’­</div>No someday/maybe items</div>'; return; }
  el.innerHTML = items.map(s => {
    const cat = s.category || 'idea';
    return `<div class="work-card">
      <div class="top">
        <div class="work-title">${esc(s.title)}</div>
        <span class="tag" style="background:rgba(167,139,250,0.15);color:#a78bfa;">someday</span>
      </div>
      ${s.description ? `<div class="work-desc">${esc(s.description)}</div>` : ''}
      <div class="work-meta">
        <span class="tag ${cat}">${cat}</span>
        ${s.agent_name ? `<span class="tag agent">${esc(s.agent_name)}</span>` : ''}
        <span class="time">${relTime(s.created_at)}</span>
        ${s.last_reviewed ? `<span class="time" title="Last reviewed">ðŸ“‹ ${relTime(s.last_reviewed)}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

function renderUsage() {
  const usage = data.usage?.today || { opus: 0, sonnet: 0, total: 0, messages: 0, subagents: 0 };
  
  // Update stats
  document.getElementById('usage-total').textContent = formatNumber(usage.total);
  document.getElementById('usage-opus').textContent = formatNumber(usage.opus);
  document.getElementById('usage-sonnet').textContent = formatNumber(usage.sonnet);
  document.getElementById('usage-messages').textContent = usage.messages || 0;
  document.getElementById('usage-subagents').textContent = usage.subagents || 0;
  
  // Render chart
  const chartEl = document.getElementById('usage-chart');
  if (!usageHistory || !usageHistory.length) {
    chartEl.innerHTML = '<div class="empty" style="padding:1rem;font-size:0.75rem;">No usage data yet</div>';
    return;
  }
  
  // Fill in missing days
  const today = new Date();
  const last7Days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const existing = usageHistory.find(h => h.date === dateStr);
    last7Days.push(existing || { date: dateStr, opus: 0, sonnet: 0, total: 0, messages: 0, subagents: 0 });
  }
  
  // Find max for scaling
  const maxTotal = Math.max(...last7Days.map(d => d.total), 1);
  
  chartEl.innerHTML = last7Days.map(day => {
    const heightPercent = (day.total / maxTotal) * 100;
    const label = new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' });
    return `<div class="usage-bar-wrapper">
      <div class="usage-bar-container">
        <div class="usage-bar" style="height: ${heightPercent}%" title="${formatNumber(day.total)} tokens"></div>
      </div>
      <div class="usage-bar-label">${label}</div>
      ${day.total > 0 ? `<div class="usage-bar-value">${formatNumberShort(day.total)}</div>` : ''}
    </div>`;
  }).join('');
}

function formatNumber(n) {
  if (!n) return '0';
  return n.toLocaleString();
}

function formatNumberShort(n) {
  if (!n) return '0';
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toString();
}

function renderFeed() {
  const el = document.getElementById('activity-feed');
  if (!data.activity.length) { el.innerHTML = '<div class="empty" style="padding:2rem"><div class="icon">ðŸ“¡</div>No activity yet</div>'; return; }
  el.innerHTML = data.activity.map(a => `
    <div class="feed-item">
      <div class="feed-msg">${esc(a.message)}</div>
      <div class="feed-meta">
        <span class="feed-type ${a.event_type}">${a.event_type}</span>
        ${a.agent_name ? `<span class="time">${esc(a.agent_name)}</span>` : ''}
        <span class="feed-time">${relTime(a.created_at)}</span>
      </div>
    </div>
  `).join('');
}

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    const c = document.getElementById('conn');
    c.className = 'conn live';
    c.innerHTML = '<span class="dot"></span> live';
  };
  ws.onclose = () => {
    const c = document.getElementById('conn');
    c.className = 'conn';
    c.innerHTML = '<span class="dot"></span> offline';
    setTimeout(connectWS, 3000);
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    const { event, data: eventData } = msg;
    
    if (!event) return;
    
    // Handle specific events for real-time updates
    switch (event) {
      case 'work:created':
        if (eventData.status === 'active' && eventData.category !== 'conversation') {
          data.active.unshift(eventData);
          renderWork('active-work', data.active, 'active-count', true);
          flashSection('active-work');
        } else if (eventData.category === 'conversation') {
          data.threadsOpen.unshift(eventData);
          renderThreads('threads-open', data.threadsOpen, 'threads-open-count', true);
          flashSection('threads-open');
        }
        break;
      
      case 'work:updated':
        updateWorkItem(eventData);
        break;
      
      case 'work:deleted':
        removeWorkItem(eventData.id);
        break;
      
      case 'activity:new':
        data.activity.unshift(eventData);
        if (data.activity.length > 30) data.activity.pop();
        renderFeed();
        flashSection('activity-feed');
        break;
      
      case 'subagent:created':
        data.subagents.unshift(eventData);
        renderSubagents();
        flashSection('subagents');
        break;
      
      case 'subagent:updated':
        updateSubagent(eventData);
        break;
      
      case 'subagent:deleted':
        data.subagents = data.subagents.filter(s => s.id !== eventData.id);
        renderSubagents();
        break;
      
      case 'scheduled:updated':
        updateScheduled(eventData);
        break;
      
      case 'someday:created':
        data.somedayMaybe.unshift(eventData);
        renderSomedayMaybe();
        flashSection('someday-maybe');
        break;
      
      case 'someday:updated':
        updateSomedayMaybe(eventData);
        break;
      
      case 'someday:deleted':
        data.somedayMaybe = data.somedayMaybe.filter(s => s.id !== eventData.id);
        renderSomedayMaybe();
        break;
      
      case 'usage:new':
        // Reload usage stats
        loadUsageStats();
        break;
      
      default:
        // Fallback: reload dashboard for unknown events
        loadDashboard();
    }
  };
}

// Agents
async function loadAgents() {
  const r = await fetch('/api/agents');
  const agents = await r.json();
  document.getElementById('agents-list').innerHTML = agents.length
    ? agents.map(a => `<div class="agent-row">
        <div style="flex:1;min-width:0;">
          <div class="agent-name">ðŸ¤– ${esc(a.name)}</div>
          <div class="agent-key" id="key-${a.id}" style="cursor:pointer;" onclick="revealAndCopy('${a.id}')" title="Click to reveal & copy">ak_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
        </div>
        <div style="display:flex;gap:0.3rem;flex-shrink:0;">
          <button class="btn-s" onclick="revealAndCopy('${a.id}')">ðŸ“‹ Copy</button>
          <button class="btn-s" style="color:var(--red)" onclick="deleteAgent('${a.id}')">Ã—</button>
        </div>
      </div>`).join('')
    : '<div class="empty" style="padding:1rem;font-size:0.8rem;">No tokens yet â€” create one above</div>';
}

async function createAgent() {
  const nameInput = document.getElementById('new-agent');
  const name = nameInput.value.trim();
  if (!name) { nameInput.focus(); return; }
  const r = await fetch('/api/agents', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
  if (r.ok) {
    const a = await r.json();
    // Show the key inline
    const display = document.getElementById('new-key-display');
    document.getElementById('new-key-value').textContent = a.apiKey;
    display.style.display = 'block';
    nameInput.value = '';
    loadAgents();
    checkTokenBanner();
  } else {
    const err = await r.json().catch(() => ({}));
    alert(err.error || 'Failed to create token');
  }
}

async function revealAndCopy(id) {
  const r = await fetch(`/api/agents/${id}/key`);
  if (r.ok) {
    const { apiKey } = await r.json();
    const el = document.getElementById(`key-${id}`);
    el.textContent = apiKey;
    el.style.color = 'var(--text)';
    try {
      await navigator.clipboard.writeText(apiKey);
      el.textContent = apiKey + '  âœ… copied';
      setTimeout(() => { el.textContent = 'ak_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; el.style.color = ''; }, 4000);
    } catch (e) {
      // Fallback: select text for manual copy
      const range = document.createRange();
      range.selectNodeContents(el);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
    }
  }
}

async function deleteAgent(id) {
  if (!confirm('Delete?')) return;
  await fetch(`/api/agents/${id}`, { method: 'DELETE' });
  loadAgents();
}

// Utils
function openModal(id) {
  if (id === 'agents-modal') {
    loadAgents();
    document.getElementById('new-key-display').style.display = 'none';
  }
  document.getElementById(id).classList.add('active');
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); }));
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal.active').forEach(m => closeModal(m.id)); });

function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function relTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  const diff = (now - d) / 1000;
  if (diff < 0) {
    const abs = Math.abs(diff);
    if (abs < 60) return 'in ' + Math.floor(abs) + 's';
    if (abs < 3600) return 'in ' + Math.floor(abs / 60) + 'm';
    if (abs < 86400) return 'in ' + Math.floor(abs / 3600) + 'h';
    return 'in ' + Math.floor(abs / 86400) + 'd';
  }
  if (diff < 60) return Math.floor(diff) + 's ago';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

init();
</script>
</body>
</html>
