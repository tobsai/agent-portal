<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‚Äî Agent Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: rgba(255,255,255,0.04);
      --surface-hover: rgba(255,255,255,0.07);
      --border: rgba(255,255,255,0.08);
      --text: #e4e4e7;
      --text-muted: #71717a;
      --text-dim: #52525b;
      --accent: #818cf8;
      --accent-dim: rgba(129,140,248,0.15);
      --green: #34d399;
      --green-dim: rgba(52,211,153,0.15);
      --yellow: #fbbf24;
      --yellow-dim: rgba(251,191,36,0.15);
      --red: #f87171;
      --red-dim: rgba(248,113,113,0.15);
      --blue: #60a5fa;
      --blue-dim: rgba(96,165,250,0.15);
      --purple: #a78bfa;
      --purple-dim: rgba(167,139,250,0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* Header & Navigation */
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50;
      background: rgba(10,10,15,0.85); backdrop-filter: blur(12px);
      flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: 1.5rem; }
    .logo { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .logo a { color: var(--text); text-decoration: none; }
    .logo a:hover { color: var(--accent); }
    .nav-links { display: flex; gap: 0.25rem; }
    .nav-link {
      font-size: 0.85rem; padding: 0.4rem 0.75rem; border-radius: 6px;
      color: var(--text-muted); text-decoration: none; transition: all 0.15s; font-weight: 500;
    }
    .nav-link:hover { background: var(--surface-hover); color: var(--text); }
    .nav-link.active { background: var(--accent-dim); color: var(--accent); }
    .header-right { display: flex; align-items: center; gap: 0.75rem; }
    .user { display: flex; align-items: center; gap: 0.5rem; }
    .user img { width: 28px; height: 28px; border-radius: 50%; }
    .user span { font-size: 0.8rem; color: var(--text-muted); }
    .btn-s { font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; text-decoration: none; }
    .btn-s:hover { background: var(--surface-hover); color: var(--text); }
    .avatar { width: 28px; height: 28px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-fallback { width: 28px; height: 28px; border-radius: 50%; background: var(--accent-dim); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; }

    /* Split Layout ‚Äî chat is first-class, gets ‚â•55% viewport height */
    .split-container {
      flex: 1; display: flex; overflow: hidden; min-height: 55vh;
    }

    /* Left Panel ‚Äî Scheduled Tasks */
    .panel-left {
      width: 50%; border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .panel-left-scroll {
      flex: 1; overflow-y: auto; padding: 1.5rem;
    }

    /* Right Panel ‚Äî Chat */
    .panel-right {
      width: 50%; display: flex; flex-direction: column; overflow: hidden;
    }
    .panel-right iframe {
      flex: 1; border: none; width: 100%; height: 100%;
    }
    .chat-expand {
      display: flex; align-items: center; justify-content: center;
      padding: 0.4rem; border-top: 1px solid var(--border);
      background: var(--surface); flex-shrink: 0;
    }
    .chat-expand a {
      font-size: 0.75rem; color: var(--text-muted); text-decoration: none;
      display: flex; align-items: center; gap: 0.35rem;
    }
    .chat-expand a:hover { color: var(--accent); }

    /* Section Headers */
    .section-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
    }
    .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text); }
    .last-updated { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

    /* Session Cards */
    .sessions-section { margin-bottom: 1.5rem; }
    .session-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;
    }

    /* Usage Section */
    .usage-section { margin-bottom: 1.5rem; }
    .usage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .usage-period-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.85rem;
    }
    .usage-period-label {
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 0.6rem;
    }
    .usage-total {
      font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 0.15rem;
      font-family: 'JetBrains Mono', monospace;
    }
    .usage-utilization {
      font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;
      font-family: 'JetBrains Mono', monospace; font-weight: 500;
    }
    .usage-utilization.high { color: var(--yellow); }
    .usage-utilization.critical { color: var(--red); }
    .usage-models { display: flex; flex-direction: column; gap: 0.5rem; }
    .usage-model-bar {
      display: grid; grid-template-columns: 3.5rem 1fr 3.5rem; gap: 0.4rem; align-items: center;
    }
    .model-name {
      font-size: 0.65rem; font-weight: 600; color: var(--text-dim); text-transform: uppercase;
      font-family: 'JetBrains Mono', monospace;
    }
    .bar-container {
      height: 14px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;
      border: 1px solid var(--border);
    }
    .bar {
      height: 100%; transition: width 0.3s ease-out;
    }
    .bar.opus { background: linear-gradient(90deg, var(--purple), #c084fc); }
    .bar.sonnet { background: linear-gradient(90deg, var(--blue), #60a5fa); }
    .model-tokens {
      font-size: 0.65rem; color: var(--text-muted); text-align: right;
      font-family: 'JetBrains Mono', monospace;
    }
    @media (max-width: 900px) {
      .usage-grid { grid-template-columns: 1fr; }
    }
    .session-card .pulse {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .session-card .pulse.active { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 2s infinite; }
    .session-card .pulse.idle { background: var(--text-dim); }
    .session-card .pulse.cron { background: var(--blue); box-shadow: 0 0 6px var(--blue); }
    .session-card .pulse.subagent { background: var(--purple); box-shadow: 0 0 6px var(--purple); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .session-info { flex: 1; min-width: 0; }
    .session-label { font-weight: 600; font-size: 0.85rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .session-meta { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; margin-top: 0.15rem; }
    .session-badge {
      font-size: 0.6rem; padding: 0.15rem 0.45rem; border-radius: 4px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; flex-shrink: 0;
    }
    .session-badge.main { background: var(--blue-dim); color: var(--blue); }
    .session-badge.cron { background: var(--green-dim); color: var(--green); }
    .session-badge.subagent { background: var(--purple-dim); color: var(--purple); }
    .session-badge.idle { background: var(--surface); color: var(--text-dim); }
    .no-sessions { text-align: center; padding: 1rem; color: var(--text-dim); font-size: 0.8rem; }

    /* Task Groups */
    .task-group { margin-bottom: 1.5rem; }
    .group-title {
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 0.5rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .group-count { font-size: 0.65rem; color: var(--text-dim); background: var(--surface); padding: 0.15rem 0.5rem; border-radius: 999px; }

    /* Task Cards */
    .task-card {
      background: var(--surface); border: 2px solid var(--border); border-radius: 10px;
      padding: 0.85rem; margin-bottom: 0.6rem; transition: all 0.15s;
    }
    .task-card:hover { background: var(--surface-hover); }
    .task-card.ok { border-color: var(--green); }
    .task-card.overdue { border-color: var(--yellow); }
    .task-card.error { border-color: var(--red); }
    .task-card.disabled { border-color: var(--border); opacity: 0.6; }

    .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .task-title { font-weight: 600; font-size: 0.9rem; color: var(--text); line-height: 1.4; }
    .task-status {
      font-size: 0.6rem; padding: 0.15rem 0.45rem; border-radius: 4px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; flex-shrink: 0;
    }
    .task-status.ok { background: var(--green-dim); color: var(--green); }
    .task-status.error { background: var(--red-dim); color: var(--red); }
    .task-status.overdue { background: var(--yellow-dim); color: var(--yellow); }

    .task-meta {
      display: grid; grid-template-columns: auto 1fr; gap: 0.3rem 0.75rem;
      font-size: 0.7rem; font-family: 'JetBrains Mono', monospace;
    }
    .task-meta-label { color: var(--text-dim); }
    .task-meta-value { color: var(--text-muted); text-align: right; }
    .task-outcome {
      margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid var(--border);
      font-size: 0.75rem; color: var(--text-muted); line-height: 1.4;
    }

    .empty { text-align: center; padding: 1.5rem; color: var(--text-dim); font-size: 0.85rem; }
    .empty .icon { font-size: 1.5rem; margin-bottom: 0.5rem; }

    /* Collapsible */
    .collapsible-header { cursor: pointer; user-select: none; display: flex; align-items: center; gap: 0.5rem; }
    .collapsible-header::before { content: '‚ñº'; font-size: 0.6rem; transition: transform 0.2s; }
    .collapsible-header.collapsed::before { transform: rotate(-90deg); }
    .collapsible-content { max-height: 2000px; overflow: hidden; transition: max-height 0.3s ease-out; }
    .collapsible-content.collapsed { max-height: 0; }

    /* Activity Timeline (below split) */
    .timeline-section {
      flex-shrink: 0; border-top: 1px solid var(--border);
      padding: 1.25rem 1.5rem;
    }
    .chart-container {
      position: relative; height: 200px; margin-top: 0.75rem;
      padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    }
    .chart-legend { display: flex; gap: 1.5rem; justify-content: center; margin-top: 0.75rem; font-size: 0.75rem; }
    .legend-item { display: flex; align-items: center; gap: 0.5rem; }
    .legend-color { width: 14px; height: 14px; border-radius: 3px; }
    .legend-color.primary { background: var(--blue); }
    .legend-color.subagent { background: var(--purple); }
    .legend-color.cron { background: var(--green); }

    /* Timeline collapse toggle */
    .timeline-toggle {
      display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;
    }
    .timeline-toggle .arrow { font-size: 0.6rem; transition: transform 0.2s; }
    .timeline-toggle.collapsed .arrow { transform: rotate(-90deg); }
    .timeline-body { transition: max-height 0.3s ease-out; max-height: 500px; overflow: hidden; }
    .timeline-body.collapsed { max-height: 0; padding: 0; }

    /* Responsive */
    @media (max-width: 900px) {
      .split-container { flex-direction: column; }
      .panel-left, .panel-right { width: 100%; height: 50%; }
      .panel-left { border-right: none; border-bottom: 1px solid var(--border); }
      .user span { display: none; }
    }
    /* ‚îÄ‚îÄ Recent Completions Feed ‚îÄ‚îÄ */
    .completions-section {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
    }
    .completions-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    .completions-title { font-size: 0.95rem; font-weight: 600; }
    .completions-feed { display: flex; flex-direction: column; gap: 0.4rem; }
    .feed-item {
      display: flex; align-items: flex-start; gap: 0.6rem;
      padding: 0.5rem 0.6rem; border-radius: 7px;
      background: var(--surface); border: 1px solid var(--border);
      font-size: 0.8rem; transition: background 0.12s;
    }
    .feed-item:hover { background: var(--surface-hover); }
    .feed-icon { font-size: 0.95rem; flex-shrink: 0; line-height: 1.4; }
    .feed-body { flex: 1; min-width: 0; }
    .feed-msg { color: var(--text); line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .feed-meta { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.15rem; display: flex; gap: 0.5rem; }
    .feed-agent { color: var(--accent); }
    .feed-empty { font-size: 0.8rem; color: var(--text-dim); padding: 1rem 0; text-align: center; }
  </style>
  <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug getPageviewId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_QBrEydH4duDZXg7OeNTpOrCb2lB77yn1S54FrnCt8Pp',{api_host:'https://analytics.mtree.io',person_profiles:'identified_only'})
  </script>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo"><a href="/">ü¶û Talos</a></div>
      <nav class="nav-links">
        <a href="/dashboard" class="nav-link active">Dashboard</a>
        <a href="/architecture" class="nav-link">Architecture</a>
        <a href="/docs" class="nav-link">Docs</a>
        <a href="/c" class="nav-link">Chat</a>
        <a href="/game" class="nav-link">üéÆ Game Assets</a>
      </nav>
    </div>
    <div class="header-right">
      <!-- Health Status Indicator -->
      <div id="health-indicator" class="health-status" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; border-radius: 6px; background: var(--surface); border: 1px solid var(--border);">
        <div class="health-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--text-dim);"></div>
        <span class="health-text" style="font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">Polling: Checking...</span>
      </div>
      <div class="user" id="user-info">
        <div class="avatar" id="user-avatar"></div>
        <span id="user-name"></span>
      </div>
      <a href="/auth/logout" class="btn-s">Logout</a>
    </div>
  </header>

  <!-- Two-Panel Split -->
  <div class="split-container">
    <!-- Left: Scheduled Tasks -->
    <div class="panel-left">
      <div class="panel-left-scroll">
        <!-- Active Sessions -->
        <div class="sessions-section">
          <div class="section-header">
            <h1 class="section-title">üî¥ Live Sessions</h1>
          </div>
          <div id="sessions-container"><div class="no-sessions">Loading...</div></div>
        </div>

        <!-- Usage Section -->
        <div class="usage-section" style="margin-bottom: 1.5rem;">
          <div class="section-header">
            <h1 class="section-title">üíé Token Usage</h1>
          </div>
          <div class="usage-grid">
            <div class="usage-period-card">
              <div class="usage-period-label">Last 24h</div>
              <div class="usage-stats" id="usage-24h">
                <div class="usage-total">‚Äî</div>
                <div class="usage-utilization">‚Äî</div>
                <div class="usage-models">
                  <div class="usage-model-bar">
                    <span class="model-name">Opus</span>
                    <div class="bar-container"><div class="bar opus" style="width: 0%"></div></div>
                    <span class="model-tokens">‚Äî</span>
                  </div>
                  <div class="usage-model-bar">
                    <span class="model-name">Sonnet</span>
                    <div class="bar-container"><div class="bar sonnet" style="width: 0%"></div></div>
                    <span class="model-tokens">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="usage-period-card">
              <div class="usage-period-label">Last 7d</div>
              <div class="usage-stats" id="usage-7d">
                <div class="usage-total">‚Äî</div>
                <div class="usage-utilization">‚Äî</div>
                <div class="usage-models">
                  <div class="usage-model-bar">
                    <span class="model-name">Opus</span>
                    <div class="bar-container"><div class="bar opus" style="width: 0%"></div></div>
                    <span class="model-tokens">‚Äî</span>
                  </div>
                  <div class="usage-model-bar">
                    <span class="model-name">Sonnet</span>
                    <div class="bar-container"><div class="bar sonnet" style="width: 0%"></div></div>
                    <span class="model-tokens">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="usage-period-card">
              <div class="usage-period-label">Last 30d</div>
              <div class="usage-stats" id="usage-30d">
                <div class="usage-total">‚Äî</div>
                <div class="usage-utilization">‚Äî</div>
                <div class="usage-models">
                  <div class="usage-model-bar">
                    <span class="model-name">Opus</span>
                    <div class="bar-container"><div class="bar opus" style="width: 0%"></div></div>
                    <span class="model-tokens">‚Äî</span>
                  </div>
                  <div class="usage-model-bar">
                    <span class="model-name">Sonnet</span>
                    <div class="bar-container"><div class="bar sonnet" style="width: 0%"></div></div>
                    <span class="model-tokens">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section-header" style="margin-top: 0.5rem;">
          <h1 class="section-title">üìÖ Scheduled Tasks</h1>
          <div class="last-updated" id="last-updated">‚Äî</div>
        </div>

        <div class="task-group" id="recurring-group">
          <div class="group-title collapsible-header" onclick="toggleGroup('recurring')">
            Recurring <span class="group-count" id="recurring-count">0</span>
          </div>
          <div class="collapsible-content" id="recurring-content"></div>
        </div>

        <div class="task-group" id="oneshots-group">
          <div class="group-title collapsible-header" onclick="toggleGroup('oneshots')">
            Upcoming One-shots <span class="group-count" id="oneshots-count">0</span>
          </div>
          <div class="collapsible-content" id="oneshots-content"></div>
        </div>

        <div class="task-group" id="disabled-group">
          <div class="group-title collapsible-header collapsed" onclick="toggleGroup('disabled')">
            Disabled/Completed <span class="group-count" id="disabled-count">0</span>
          </div>
          <div class="collapsible-content collapsed" id="disabled-content"></div>
        </div>
      </div>
    </div>

    <!-- Right: Embedded Chat -->
    <div class="panel-right">
      <iframe src="/c?embed=1" id="chat-frame"></iframe>
      <div class="chat-expand">
        <a href="/c" title="Open full-screen chat">‚Üó Full-screen chat</a>
      </div>
    </div>
  </div>

  <!-- Activity Timeline (collapsible, below split) -->
  <div class="timeline-section" id="timeline-section">
    <div class="timeline-toggle collapsed" onclick="toggleTimeline()">
      <span class="arrow">‚ñº</span>
      <span class="section-title" style="font-size:1rem;">üìä Activity (24h)</span>
    </div>
    <div class="timeline-body collapsed" id="timeline-body">
      <div class="chart-container">
        <canvas id="activity-chart"></canvas>
      </div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-color primary"></div><span>Primary</span></div>
        <div class="legend-item"><div class="legend-color subagent"></div><span>Sub-agents</span></div>
        <div class="legend-item"><div class="legend-color cron"></div><span>Cron</span></div>
      </div>
    </div>
  </div>

  <!-- Recent Completions Feed -->
  <div class="completions-section">
    <div class="completions-header">
      <span class="completions-title">üìã Recent Activity</span>
      <span style="font-size:0.72rem; color:var(--text-dim);" id="completions-updated"></span>
    </div>
    <div class="completions-feed" id="completions-feed">
      <div class="feed-empty">Loading‚Ä¶</div>
    </div>
  </div>

  <script>
    let scheduledTasks = [];
    let activityChart = null;

    async function init() {
      await loadUser();
      await loadAgentHealth();
      await loadLiveSessions();
      await loadUsage();
      await loadScheduledTasks();
      await loadActivityTimeline();
      await loadRecentActivity();
      setInterval(loadAgentHealth, 30000); // Check health every 30 seconds
      setInterval(loadLiveSessions, 15000);
      setInterval(loadUsage, 60000); // Refresh usage every minute
      setInterval(loadScheduledTasks, 60000);
      setInterval(loadActivityTimeline, 300000);
      setInterval(loadRecentActivity, 30000);
      setInterval(updateRelativeTimes, 10000);
    }
    
    async function loadAgentHealth() {
      try {
        const agentId = '689681ce-db81-4943-82f6-355e566c2603'; // Talos agent ID
        const res = await fetch(`/api/agent-health?agent_id=${agentId}`);
        if (!res.ok) {
          updateHealthIndicator('unknown', 'No health data');
          return;
        }
        const data = await res.json();
        
        const { staleness, iMessagePolling } = data;
        const now = new Date();
        
        // Determine health status
        let status = 'healthy';
        let message = 'Active';
        
        if (staleness.reportStale) {
          status = 'error';
          message = `‚ö†Ô∏è No report (${staleness.minutesSinceReport}m ago)`;
        } else if (staleness.pollStale) {
          status = 'warning';
          message = `‚ö†Ô∏è Poll stale (${staleness.minutesSincePoll}m ago)`;
        } else if (iMessagePolling.pollingActive && staleness.minutesSincePoll !== null) {
          status = 'healthy';
          message = `‚úì Active (${staleness.minutesSincePoll}m ago)`;
        } else {
          status = 'idle';
          message = 'Idle';
        }
        
        updateHealthIndicator(status, message);
      } catch (err) {
        console.error('Failed to load agent health:', err);
        updateHealthIndicator('error', 'Health check failed');
      }
    }
    
    function updateHealthIndicator(status, message) {
      const indicator = document.getElementById('health-indicator');
      if (!indicator) return;
      
      const dot = indicator.querySelector('.health-dot');
      const text = indicator.querySelector('.health-text');
      
      // Update dot color
      const dotColors = {
        healthy: 'var(--green)',
        warning: 'var(--yellow)',
        error: 'var(--red)',
        idle: 'var(--text-dim)',
        unknown: 'var(--text-dim)'
      };
      dot.style.background = dotColors[status] || 'var(--text-dim)';
      
      // Update text
      text.textContent = `Polling: ${message}`;
      text.style.color = status === 'healthy' ? 'var(--green)' : status === 'warning' ? 'var(--yellow)' : status === 'error' ? 'var(--red)' : 'var(--text-muted)';
    }

    async function loadLiveSessions() {
      try {
        const res = await fetch('/api/live-sessions');
        const data = await res.json();
        renderLiveSessions(data.sessions || []);
      } catch (err) { console.error('Failed to load live sessions:', err); }
    }

    function renderLiveSessions(sessions) {
      const container = document.getElementById('sessions-container');
      if (!sessions.length) {
        container.innerHTML = '<div class="no-sessions">No active sessions</div>';
        return;
      }
      container.innerHTML = sessions.map(s => {
        const isMain = s.session_key === 'agent:main:main';
        const isCron = s.session_key.includes(':cron:');
        const isSub = s.kind === 'subagent' || s.session_key.includes(':spawn:');
        const pulseClass = isMain ? 'active' : isCron ? 'cron' : isSub ? 'subagent' : 'idle';
        const badgeClass = isMain ? 'main' : isCron ? 'cron' : isSub ? 'subagent' : 'idle';
        const badgeText = isMain ? 'Main' : isCron ? 'Cron' : isSub ? 'Sub-agent' : 'Session';
        const label = s.label || (isMain ? 'Main Session' : s.session_key.split(':').pop());
        const model = s.model ? s.model.replace('claude-', '') : '';
        const tokens = s.total_tokens ? `${Math.round(s.total_tokens / 1000)}k tokens` : '';
        const meta = [model, tokens, s.channel].filter(Boolean).join(' ¬∑ ');
        const msg = s.last_message ? s.last_message.substring(0, 80) + (s.last_message.length > 80 ? '‚Ä¶' : '') : '';
        return `<div class="session-card">
          <div class="pulse ${pulseClass}"></div>
          <div class="session-info">
            <div class="session-label">${esc(label)}</div>
            <div class="session-meta">${esc(meta)}</div>
            ${msg ? `<div class="session-meta" style="color:var(--text-muted);margin-top:0.2rem;">${esc(msg)}</div>` : ''}
          </div>
          <div class="session-badge ${badgeClass}">${badgeText}</div>
        </div>`;
      }).join('');
    }

    async function loadUser() {
      const r = await fetch('/api/me');
      const u = await r.json();
      if (u) {
        const avatarEl = document.getElementById('user-avatar');
        const nameEl = document.getElementById('user-name');
        nameEl.textContent = u.name || u.email;
        if (u.picture) {
          const img = document.createElement('img');
          img.src = u.picture; img.alt = u.name || ''; img.referrerPolicy = 'no-referrer';
          img.onerror = () => { avatarEl.innerHTML = ''; avatarEl.appendChild(makeAvatarFallback(u.name || u.email)); };
          avatarEl.appendChild(img);
        } else {
          avatarEl.appendChild(makeAvatarFallback(u.name || u.email));
        }
      }
    }

    async function loadUsage() {
      try {
        const res = await fetch('/api/usage');
        const data = await res.json();
        renderUsage('24h', data.last24h);
        renderUsage('7d', data.last7d);
        renderUsage('30d', data.last30d);
      } catch (err) { console.error('Failed to load usage:', err); }
    }

    function renderUsage(period, data) {
      const container = document.getElementById(`usage-${period}`);
      if (!data) return;

      // Calculate totals
      const totalTokens = data.total || 0;
      const opusTokens = data.opus?.total || 0;
      const sonnetTokens = data.sonnet?.total || 0;

      // Plan limits (approximate weekly limits for Anthropic Max plan)
      const WEEKLY_OPUS_LIMIT = 180_000_000;  // ~180M tokens/week for Opus (Max $200 = 20x Pro)
      const WEEKLY_SONNET_LIMIT = 360_000_000; // ~360M tokens/week for Sonnet (Max $200 = 20x Pro)

      // Format numbers
      const formatTokens = (n) => {
        if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
        if (n >= 1000) return (n / 1000).toFixed(0) + 'k';
        return n.toString();
      };

      // Update total tokens display
      container.querySelector('.usage-total').textContent = formatTokens(totalTokens);

      // Utilization display (only show percentage for 7d view)
      const utilizationEl = container.querySelector('.usage-utilization');
      if (period === '7d') {
        // Calculate utilization percentage for weekly view
        const opusPercent = Math.round((opusTokens / WEEKLY_OPUS_LIMIT) * 100);
        const sonnetPercent = Math.round((sonnetTokens / WEEKLY_SONNET_LIMIT) * 100);
        const maxPercent = Math.max(opusPercent, sonnetPercent);
        
        utilizationEl.textContent = `${maxPercent}% of weekly limit`;
        utilizationEl.className = 'usage-utilization';
        if (maxPercent >= 90) utilizationEl.classList.add('critical');
        else if (maxPercent >= 70) utilizationEl.classList.add('high');
        
        // For 7d view, bars show utilization percentage
        const opusBar = container.querySelectorAll('.usage-model-bar')[0];
        opusBar.querySelector('.bar').style.width = `${Math.min(opusPercent, 100)}%`;
        opusBar.querySelector('.model-tokens').textContent = `${opusPercent}%`;

        const sonnetBar = container.querySelectorAll('.usage-model-bar')[1];
        sonnetBar.querySelector('.bar').style.width = `${Math.min(sonnetPercent, 100)}%`;
        sonnetBar.querySelector('.model-tokens').textContent = `${sonnetPercent}%`;
      } else {
        // For 24h and 30d, just show token counts
        utilizationEl.textContent = `${formatTokens(opusTokens)} Opus ¬∑ ${formatTokens(sonnetTokens)} Sonnet`;
        utilizationEl.className = 'usage-utilization';
        
        // Bars show relative usage between models
        const maxTokens = Math.max(opusTokens, sonnetTokens);
        const opusWidth = maxTokens > 0 ? Math.round((opusTokens / maxTokens) * 100) : 0;
        const sonnetWidth = maxTokens > 0 ? Math.round((sonnetTokens / maxTokens) * 100) : 0;

        const opusBar = container.querySelectorAll('.usage-model-bar')[0];
        opusBar.querySelector('.bar').style.width = `${opusWidth}%`;
        opusBar.querySelector('.model-tokens').textContent = formatTokens(opusTokens);

        const sonnetBar = container.querySelectorAll('.usage-model-bar')[1];
        sonnetBar.querySelector('.bar').style.width = `${sonnetWidth}%`;
        sonnetBar.querySelector('.model-tokens').textContent = formatTokens(sonnetTokens);
      }
    }

    function makeAvatarFallback(name) {
      const div = document.createElement('div');
      div.className = 'avatar-fallback';
      div.textContent = (name || '?').split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
      return div;
    }

    async function loadScheduledTasks() {
      try {
        const res = await fetch('/api/scheduled-tasks');
        const data = await res.json();
        scheduledTasks = data.tasks || [];
        if (data.updatedAt) {
          document.getElementById('last-updated').textContent = 'Updated ' + formatRelativeTime(new Date(data.updatedAt));
        }
        renderScheduledTasks();
      } catch (err) { console.error('Failed to load scheduled tasks:', err); }
    }

    function renderScheduledTasks() {
      const recurring = [], oneshots = [], disabled = [];
      scheduledTasks.forEach(task => {
        if (!task.enabled) disabled.push(task);
        else if (task.schedule && task.schedule.kind === 'at') oneshots.push(task);
        else recurring.push(task);
      });
      oneshots.sort((a, b) => new Date(a.nextRunAt) - new Date(b.nextRunAt));
      renderTaskGroup('recurring', recurring);
      renderTaskGroup('oneshots', oneshots);
      renderTaskGroup('disabled', disabled);
      document.getElementById('recurring-count').textContent = recurring.length;
      document.getElementById('oneshots-count').textContent = oneshots.length;
      document.getElementById('disabled-count').textContent = disabled.length;
    }

    function renderTaskGroup(groupId, tasks) {
      const container = document.getElementById(`${groupId}-content`);
      if (tasks.length === 0) {
        container.innerHTML = '<div class="empty"><div class="icon">üì≠</div>No tasks</div>';
        return;
      }
      container.innerHTML = tasks.map(task => {
        const bc = getTaskBorderClass(task), sc = getTaskStatusClass(task), st = getTaskStatusText(task);
        return `<div class="task-card ${bc}">
          <div class="task-header">
            <div class="task-title">${esc(task.name)}</div>
            <div class="task-status ${sc}">${st}</div>
          </div>
          <div class="task-meta">
            <div class="task-meta-label">Schedule:</div><div class="task-meta-value">${esc(task.scheduleHuman || 'Unknown')}</div>
            <div class="task-meta-label">Last ran:</div><div class="task-meta-value">${task.lastRunAt ? formatRelativeTime(new Date(task.lastRunAt)) : 'Never'}</div>
            <div class="task-meta-label">Next run:</div><div class="task-meta-value">${task.nextRunAt ? formatRelativeTime(new Date(task.nextRunAt)) : '‚Äî'}</div>
          </div>
          ${task.lastOutcome ? `<div class="task-outcome">${esc(task.lastOutcome)}</div>` : ''}
        </div>`;
      }).join('');
    }

    function isOverdue(t) {
      if (!t.nextRunAt) return false;
      const now = Date.now(), next = new Date(t.nextRunAt).getTime();
      if (next >= now) return false;
      // Grace: overdue only if missed by more than the interval (or 30 min minimum)
      const last = t.lastRunAt ? new Date(t.lastRunAt).getTime() : 0;
      const interval = last ? Math.max(next - last, 1800000) : 1800000; // fallback 30 min
      return (now - next) > interval;
    }
    function getTaskBorderClass(t) {
      if (!t.enabled) return 'disabled';
      if (t.lastStatus === 'error' || t.lastStatus === 'failed') return 'error';
      if (isOverdue(t)) return 'overdue';
      if (t.lastStatus === 'ok' || t.lastStatus === 'completed') return 'ok';
      return '';
    }
    function getTaskStatusClass(t) {
      if (t.lastStatus === 'error' || t.lastStatus === 'failed') return 'error';
      if (isOverdue(t)) return 'overdue';
      if (t.lastStatus === 'ok' || t.lastStatus === 'completed') return 'ok';
      return '';
    }
    function getTaskStatusText(t) {
      if (t.lastStatus === 'error' || t.lastStatus === 'failed') return 'Error';
      if (isOverdue(t)) return 'Overdue';
      if (t.lastStatus === 'ok' || t.lastStatus === 'completed') return 'OK';
      return '‚Äî';
    }

    function formatRelativeTime(date) {
      const now = new Date(), diffMs = date - now;
      const diffMins = Math.floor(Math.abs(diffMs) / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      const past = diffMs < 0;
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${past ? '' : 'in '}${diffMins}m${past ? ' ago' : ''}`;
      if (diffHours < 24) return `${past ? '' : 'in '}${diffHours}h${past ? ' ago' : ''}`;
      if (diffDays < 7) return `${past ? '' : 'in '}${diffDays}d${past ? ' ago' : ''}`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function updateRelativeTimes() { renderScheduledTasks(); }

    function toggleGroup(id) {
      document.querySelector(`#${id}-group .collapsible-header`).classList.toggle('collapsed');
      document.getElementById(`${id}-content`).classList.toggle('collapsed');
    }

    function toggleTimeline() {
      document.querySelector('.timeline-toggle').classList.toggle('collapsed');
      document.getElementById('timeline-body').classList.toggle('collapsed');
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    // ===== Activity Timeline =====
    async function loadActivityTimeline() {
      try {
        const res = await fetch('/api/activity-timeline');
        const data = await res.json();
        renderActivityChart(data.hours);
      } catch (err) { console.error('Failed to load activity timeline:', err); }
    }

    function renderActivityChart(hours) {
      const ctx = document.getElementById('activity-chart').getContext('2d');
      const labels = hours.map(h => new Date(h.hour).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }));
      if (activityChart) activityChart.destroy();
      activityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Primary', data: hours.map(h => h.primary), backgroundColor: 'rgba(96,165,250,0.8)', borderColor: 'rgba(96,165,250,1)', borderWidth: 1 },
            { label: 'Sub-agents', data: hours.map(h => h.subagent), backgroundColor: 'rgba(167,139,250,0.8)', borderColor: 'rgba(167,139,250,1)', borderWidth: 1 },
            { label: 'Cron', data: hours.map(h => h.cron), backgroundColor: 'rgba(52,211,153,0.8)', borderColor: 'rgba(52,211,153,1)', borderWidth: 1 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            x: { stacked: true, grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false }, ticks: { color: '#71717a', maxRotation: 45, minRotation: 45, font: { size: 9, family: 'JetBrains Mono' } } },
            y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false }, ticks: { color: '#71717a', stepSize: 1, font: { size: 10 } } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { backgroundColor: 'rgba(10,10,15,0.95)', titleColor: '#e4e4e7', bodyColor: '#e4e4e7', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, padding: 10 }
          }
        }
      });
    }

    // ‚îÄ‚îÄ Recent Activity Feed ‚îÄ‚îÄ
    const ACTIVITY_ICONS = {
      'task_complete': '‚úÖ', 'complete': '‚úÖ', 'done': '‚úÖ',
      'task_start': '‚ñ∂Ô∏è', 'start': '‚ñ∂Ô∏è', 'started': '‚ñ∂Ô∏è',
      'error': '‚ùå', 'fail': '‚ùå', 'failed': '‚ùå',
      'deploy': 'üöÄ', 'deployed': 'üöÄ',
      'build': 'üî®', 'built': 'üî®',
      'message': 'üí¨', 'chat': 'üí¨',
      'heartbeat': 'üíì',
      'subagent': 'ü§ñ', 'spawn': 'ü§ñ',
      'update': 'üìù', 'note': 'üìù',
      'cron': '‚è∞', 'scheduled': '‚è∞',
      'info': '‚ÑπÔ∏è',
    };

    function activityIcon(eventType) {
      if (!eventType) return 'üìã';
      const lower = eventType.toLowerCase();
      for (const [key, icon] of Object.entries(ACTIVITY_ICONS)) {
        if (lower.includes(key)) return icon;
      }
      return 'üìã';
    }

    function timeAgo(iso) {
      const diff = Date.now() - new Date(iso).getTime();
      const m = Math.floor(diff / 60000);
      if (m < 1) return 'just now';
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h}h ago`;
      return `${Math.floor(h / 24)}d ago`;
    }

    async function loadRecentActivity() {
      try {
        const res = await fetch('/api/activity?limit=20');
        if (!res.ok) throw new Error(res.statusText);
        const items = await res.json();
        const feed = document.getElementById('completions-feed');
        const updEl = document.getElementById('completions-updated');
        if (updEl) updEl.textContent = 'Updated ' + timeAgo(new Date().toISOString());

        if (!items || items.length === 0) {
          feed.innerHTML = '<div class="feed-empty">No activity yet.</div>';
          return;
        }

        feed.innerHTML = items.map(item => `
          <div class="feed-item">
            <span class="feed-icon">${activityIcon(item.event_type)}</span>
            <div class="feed-body">
              <div class="feed-msg" title="${escHtml(item.message || '')}">${escHtml(item.message || '(no message)')}</div>
              <div class="feed-meta">
                <span>${timeAgo(item.created_at)}</span>
                ${item.agent_name ? `<span class="feed-agent">${escHtml(item.agent_name)}</span>` : ''}
                ${item.event_type ? `<span>${escHtml(item.event_type)}</span>` : ''}
              </div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        const feed = document.getElementById('completions-feed');
        if (feed) feed.innerHTML = `<div class="feed-empty">Failed to load activity.</div>`;
      }
    }

    function escHtml(str) {
      return String(str || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    init();
  </script>
</body>
</html>
