<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: rgba(255,255,255,0.04);
      --surface-hover: rgba(255,255,255,0.07);
      --border: rgba(255,255,255,0.08);
      --text: #e4e4e7;
      --text-muted: #71717a;
      --text-dim: #52525b;
      --accent: #818cf8;
      --accent-dim: rgba(129,140,248,0.15);
      --green: #34d399;
      --green-dim: rgba(52,211,153,0.15);
      --yellow: #fbbf24;
      --yellow-dim: rgba(251,191,36,0.15);
      --red: #f87171;
      --blue: #60a5fa;
      --blue-dim: rgba(96,165,250,0.15);
      --purple: #a78bfa;
      --purple-dim: rgba(167,139,250,0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* Header */
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50;
      background: rgba(10,10,15,0.85); backdrop-filter: blur(12px);
    }
    .logo { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .logo .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px var(--green); }
    .header-right { display: flex; align-items: center; gap: 0.75rem; }
    .conn { font-size: 0.7rem; color: var(--text-dim); display: flex; align-items: center; gap: 0.35rem; }
    .conn .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-dim); }
    .conn.live .dot { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .conn.live { color: var(--text-muted); }
    .user { display: flex; align-items: center; gap: 0.5rem; }
    .user img { width: 28px; height: 28px; border-radius: 50%; }
    .user span { font-size: 0.8rem; color: var(--text-muted); }
    .btn-s { font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; }
    .btn-s:hover { background: var(--surface-hover); color: var(--text); }

    /* Layout */
    .layout { display: grid; grid-template-columns: 1fr 340px; gap: 0; min-height: calc(100vh - 49px); }
    .main { padding: 1.5rem; overflow-y: auto; }
    .sidebar { border-left: 1px solid var(--border); overflow-y: auto; }

    /* Sections */
    .section { margin-bottom: 2rem; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
    .section-count { font-size: 0.65rem; color: var(--text-dim); background: var(--surface); padding: 0.15rem 0.5rem; border-radius: 999px; }

    /* Work Items */
    .work-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.85rem 1rem; margin-bottom: 0.5rem; transition: background 0.15s;
    }
    .work-card:hover { background: var(--surface-hover); }
    .work-card .top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.35rem; }
    .work-title { font-weight: 500; font-size: 0.9rem; line-height: 1.4; }
    .work-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; margin-top: 0.25rem; }
    .work-meta { display: flex; gap: 0.6rem; align-items: center; margin-top: 0.5rem; flex-wrap: wrap; }
    .tag { font-size: 0.65rem; font-weight: 500; padding: 0.15rem 0.5rem; border-radius: 4px; }
    .tag.active { background: var(--green-dim); color: var(--green); }
    .tag.completed { background: var(--surface); color: var(--text-dim); }
    .tag.task { background: var(--blue-dim); color: var(--blue); }
    .tag.research { background: var(--purple-dim); color: var(--purple); }
    .tag.deploy { background: var(--yellow-dim); color: var(--yellow); }
    .tag.agent { background: var(--accent-dim); color: var(--accent); }
    .time { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

    /* Sub-agents */
    .subagent-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.75rem 1rem; margin-bottom: 0.5rem;
    }
    .subagent-header { display: flex; justify-content: space-between; align-items: center; }
    .subagent-label { font-weight: 500; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace; }
    .subagent-task { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.3rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .status-dot.running { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); animation: pulse 2s infinite; }
    .status-dot.completed { background: var(--green); }
    .status-dot.failed { background: var(--red); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Scheduled */
    .sched-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.6rem 0; border-bottom: 1px solid var(--border);
    }
    .sched-item:last-child { border-bottom: none; }
    .sched-name { font-size: 0.85rem; font-weight: 500; }
    .sched-detail { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.15rem; }
    .sched-next { font-size: 0.7rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; text-align: right; }

    /* Activity Feed (sidebar) */
    .feed { padding: 0; }
    .feed-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    .feed-header h3 { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
    .feed-list { padding: 0; }
    .feed-item { padding: 0.65rem 1rem; border-bottom: 1px solid var(--border); }
    .feed-item:hover { background: var(--surface); }
    .feed-msg { font-size: 0.8rem; line-height: 1.5; }
    .feed-meta { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.25rem; }
    .feed-type { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .feed-type.heartbeat { color: var(--green); }
    .feed-type.work { color: var(--blue); }
    .feed-type.subagent { color: var(--purple); }
    .feed-type.deploy { color: var(--yellow); }
    .feed-type.alert { color: var(--red); }
    .feed-time { font-size: 0.65rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

    .empty { text-align: center; padding: 2rem; color: var(--text-dim); font-size: 0.85rem; }
    .empty .icon { font-size: 1.5rem; margin-bottom: 0.5rem; }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 200; }
    .modal.active { display: flex; }
    .modal-box { background: #16161d; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid var(--border); overflow: hidden; }
    .modal-head { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    .modal-head h3 { font-size: 0.95rem; }
    .modal-close { background: none; border: none; color: var(--text-dim); font-size: 1.2rem; cursor: pointer; }
    .modal-body { padding: 1rem; }
    .field { margin-bottom: 0.85rem; }
    .field label { display: block; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); margin-bottom: 0.3rem; }
    .field input, .field textarea { width: 100%; padding: 0.5rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem; font-family: inherit; }
    .field input:focus, .field textarea:focus { outline: none; border-color: var(--accent); }
    .field textarea { min-height: 60px; resize: vertical; }
    .agents-grid { display: grid; grid-template-columns: 1fr; gap: 0.5rem; }
    .agent-row { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 0.6rem 0.8rem; border-radius: 8px; }
    .agent-name { font-weight: 500; font-size: 0.85rem; }
    .agent-key { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-dim); }

    @media (max-width: 768px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { border-left: none; border-top: 1px solid var(--border); max-height: 400px; }
      .user span { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><span class="dot"></span> Agent Portal</div>
    <div class="header-right">
      <div class="conn" id="conn"><span class="dot"></span> connecting</div>
      <button class="btn-s" onclick="openModal('agents-modal')">âš™ Agents</button>
      <div class="user" id="user-info">
        <img id="user-pic" src="" alt="">
        <span id="user-name"></span>
      </div>
      <a href="/auth/logout" class="btn-s">Logout</a>
    </div>
  </header>

  <div class="layout">
    <div class="main">
      <!-- Active Work -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ”¨ Currently Working On</span>
          <span class="section-count" id="active-count">0</span>
        </div>
        <div id="active-work"></div>
      </div>

      <!-- Sub-Agents -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ¤– Sub-Agents</span>
          <span class="section-count" id="subagent-count">0</span>
        </div>
        <div id="subagents"></div>
      </div>

      <!-- Scheduled -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">ðŸ“… Scheduled</span>
          <span class="section-count" id="sched-count">0</span>
        </div>
        <div id="scheduled"></div>
      </div>

      <!-- Completed -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">âœ… Recently Completed</span>
          <span class="section-count" id="completed-count">0</span>
        </div>
        <div id="completed-work"></div>
      </div>
    </div>

    <div class="sidebar">
      <div class="feed">
        <div class="feed-header"><h3>Activity Feed</h3></div>
        <div class="feed-list" id="activity-feed"></div>
      </div>
    </div>
  </div>

  <!-- Agents Modal -->
  <div class="modal" id="agents-modal">
    <div class="modal-box" style="max-width:550px;">
      <div class="modal-head">
        <h3>âš™ Manage Agents</h3>
        <button class="modal-close" onclick="closeModal('agents-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="field" style="display:flex;gap:0.5rem;">
          <input id="new-agent" placeholder="Agent nameâ€¦" style="flex:1">
          <button class="btn-s" style="background:var(--accent);color:#000;border:none;font-weight:600;" onclick="createAgent()">Add</button>
        </div>
        <div class="agents-grid" id="agents-list"></div>
      </div>
    </div>
  </div>

<script>
let ws, data = { active: [], completed: [], subagents: [], scheduled: [], activity: [] };

async function init() {
  await loadUser();
  await checkBootstrap();
  await loadDashboard();
  connectWS();
}

async function checkBootstrap() {
  // Check if any agents exist; if not, offer to bootstrap
  const r = await fetch('/api/agents');
  if (!r.ok) return;
  const agents = await r.json();
  if (agents.length === 0) {
    if (confirm('No agents configured yet. Create a default "Talos" agent now?')) {
      const br = await fetch('/api/bootstrap', { method: 'POST' });
      if (br.ok) {
        const data = await br.json();
        if (data.agent) {
          alert('Agent created!\\n\\nAPI Key: ' + data.agent.apiKey + '\\n\\nCopy this key â€” it\\'s shown once.');
        }
      }
    }
  }
}

async function loadUser() {
  const r = await fetch('/api/me');
  const u = await r.json();
  if (u) {
    document.getElementById('user-pic').src = u.picture || '';
    document.getElementById('user-name').textContent = u.name || u.email;
  }
}

async function loadDashboard() {
  const r = await fetch('/api/dashboard');
  data = await r.json();
  render();
}

function render() {
  renderWork('active-work', data.active, 'active-count', true);
  renderWork('completed-work', data.completed, 'completed-count', false);
  renderSubagents();
  renderScheduled();
  renderFeed();
}

function renderWork(containerId, items, countId, isActive) {
  document.getElementById(countId).textContent = items.length;
  const el = document.getElementById(containerId);
  if (!items.length) { el.innerHTML = `<div class="empty"><div class="icon">${isActive ? 'â˜•' : 'ðŸ“­'}</div>${isActive ? 'All quiet' : 'Nothing yet'}</div>`; return; }
  el.innerHTML = items.map(w => {
    const cat = w.category || 'task';
    return `<div class="work-card">
      <div class="top">
        <div class="work-title">${esc(w.title)}</div>
        <span class="tag ${isActive ? 'active' : 'completed'}">${isActive ? 'active' : 'done'}</span>
      </div>
      ${w.description ? `<div class="work-desc">${esc(w.description)}</div>` : ''}
      <div class="work-meta">
        <span class="tag ${cat}">${cat}</span>
        ${w.agent_name ? `<span class="tag agent">${esc(w.agent_name)}</span>` : ''}
        <span class="time">${relTime(isActive ? w.started_at : w.completed_at)}</span>
      </div>
    </div>`;
  }).join('');
}

function renderSubagents() {
  const items = data.subagents;
  document.getElementById('subagent-count').textContent = items.length;
  const el = document.getElementById('subagents');
  if (!items.length) { el.innerHTML = '<div class="empty"><div class="icon">ðŸ¤–</div>No sub-agents</div>'; return; }
  el.innerHTML = items.map(s => `
    <div class="subagent-card">
      <div class="subagent-header">
        <span class="subagent-label">${esc(s.label || s.id.slice(0,8))}</span>
        <span style="display:flex;align-items:center;gap:0.4rem;">
          <span class="status-dot ${s.status}"></span>
          <span class="time">${s.status}</span>
        </span>
      </div>
      <div class="subagent-task">${esc(s.task)}</div>
      ${s.result ? `<div class="work-desc" style="margin-top:0.4rem;">${esc(s.result)}</div>` : ''}
      <div class="work-meta"><span class="time">${relTime(s.started_at)}</span></div>
    </div>
  `).join('');
}

function renderScheduled() {
  const items = data.scheduled;
  document.getElementById('sched-count').textContent = items.length;
  const el = document.getElementById('scheduled');
  if (!items.length) { el.innerHTML = '<div class="empty"><div class="icon">ðŸ“…</div>No scheduled items</div>'; return; }
  el.innerHTML = items.map(s => `
    <div class="sched-item">
      <div>
        <div class="sched-name">${esc(s.name)}</div>
        <div class="sched-detail">${esc(s.schedule_type)}${s.schedule_expr ? ' Â· ' + esc(s.schedule_expr) : ''}</div>
      </div>
      <div class="sched-next">${s.next_run ? relTime(s.next_run) : 'â€”'}</div>
    </div>
  `).join('');
}

function renderFeed() {
  const el = document.getElementById('activity-feed');
  if (!data.activity.length) { el.innerHTML = '<div class="empty" style="padding:2rem"><div class="icon">ðŸ“¡</div>No activity yet</div>'; return; }
  el.innerHTML = data.activity.map(a => `
    <div class="feed-item">
      <div class="feed-msg">${esc(a.message)}</div>
      <div class="feed-meta">
        <span class="feed-type ${a.event_type}">${a.event_type}</span>
        ${a.agent_name ? `<span class="time">${esc(a.agent_name)}</span>` : ''}
        <span class="feed-time">${relTime(a.created_at)}</span>
      </div>
    </div>
  `).join('');
}

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    const c = document.getElementById('conn');
    c.className = 'conn live';
    c.innerHTML = '<span class="dot"></span> live';
  };
  ws.onclose = () => {
    const c = document.getElementById('conn');
    c.className = 'conn';
    c.innerHTML = '<span class="dot"></span> offline';
    setTimeout(connectWS, 3000);
  };
  ws.onmessage = (e) => {
    const { event } = JSON.parse(e.data);
    // Refresh on any event
    if (event) loadDashboard();
  };
}

// Agents
async function loadAgents() {
  const r = await fetch('/api/agents');
  const agents = await r.json();
  document.getElementById('agents-list').innerHTML = agents.length
    ? agents.map(a => `<div class="agent-row">
        <div><div class="agent-name">ðŸ¤– ${esc(a.name)}</div><div class="agent-key" id="key-${a.id}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div></div>
        <div style="display:flex;gap:0.3rem;">
          <button class="btn-s" onclick="revealKey('${a.id}')">Show</button>
          <button class="btn-s" style="color:var(--red)" onclick="deleteAgent('${a.id}')">Ã—</button>
        </div>
      </div>`).join('')
    : '<div class="empty">No agents</div>';
}

async function createAgent() {
  const name = document.getElementById('new-agent').value.trim();
  if (!name) return;
  const r = await fetch('/api/agents', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
  if (r.ok) {
    const a = await r.json();
    alert(`API Key: ${a.apiKey}\n\nSave this â€” shown once.`);
    document.getElementById('new-agent').value = '';
    loadAgents();
  }
}

async function revealKey(id) {
  const r = await fetch(`/api/agents/${id}/key`);
  if (r.ok) { const { apiKey } = await r.json(); document.getElementById(`key-${id}`).textContent = apiKey; }
}

async function deleteAgent(id) {
  if (!confirm('Delete?')) return;
  await fetch(`/api/agents/${id}`, { method: 'DELETE' });
  loadAgents();
}

// Utils
function openModal(id) {
  if (id === 'agents-modal') loadAgents();
  document.getElementById(id).classList.add('active');
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); }));
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal.active').forEach(m => closeModal(m.id)); });

function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function relTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  const diff = (now - d) / 1000;
  if (diff < 0) {
    const abs = Math.abs(diff);
    if (abs < 60) return 'in ' + Math.floor(abs) + 's';
    if (abs < 3600) return 'in ' + Math.floor(abs / 60) + 'm';
    if (abs < 86400) return 'in ' + Math.floor(abs / 3600) + 'h';
    return 'in ' + Math.floor(abs / 86400) + 'd';
  }
  if (diff < 60) return Math.floor(diff) + 's ago';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

init();
</script>
</body>
</html>
